import type { LlmConfig, LlmMessage } from "../llmClient";

export async function chatOpenAI(env: Env, cfg: LlmConfig, messages: LlmMessage[]) {
  if (!env.OPENAI_API_KEY) throw new Error("Missing OPENAI_API_KEY");
  const res = await fetch("https://gateway.ai.cloudflare.com/v1/004dc1af737b22a8aa83b3550fa9b9d3/wbs-agent-test/openai/responses", {
    method: "POST",
    headers: {
      "content-type": "application/json",
      "Authorization": `Bearer ${env.OPENAI_API_KEY}`,
      "cf-aig-authorization": `Bearer ${env.CF_GATEWAY_KEY}`
    },
    body: JSON.stringify({
      model: cfg.model,
      input: messages,
      max_output_tokens: cfg.maxTokens ?? 4096,
    })
  });
  if (!res.ok) throw new Error(`OpenAI failed: ${res.status} ${await res.text()}`);
  const data: any = await res.json();
  return data.output.find(x => x.type === 'message')?.content.find(x => x.type === 'output_text')?.text;
}
/*
{
  "id": "resp_00e50a08caf984e5006943945b59088197965d0e87b3bc1571",
  "object": "response",
  "created_at": 1766036571,
  "status": "completed",
  "background": false,
  "billing": {
    "payer": "developer"
  },
  "error": null,
  "incomplete_details": null,
  "instructions": null,
  "max_output_tokens": 60000,
  "max_tool_calls": null,
  "model": "gpt-5-mini-2025-08-07",
  "output": [
    {
      "id": "rs_00e50a08caf984e5006943945bd4508197bfa22375a37fd395",
      "type": "reasoning",
      "summary": []
    },
    {
      "id": "msg_00e50a08caf984e500694394c3ea0c8197b0f15cb0274dc751",
      "type": "message",
      "status": "completed",
      "content": [
        {
          "type": "output_text",
          "annotations": [],
          "logprobs": [],
          "text": "{\n  \"regionId\": \"59de81e2-0e6c-4346-b975-a32e937c806e\",\n  \"confidence\": 0.77,\n  \"notes\": \"Extracted explicit WBS lines and numbered items. Parents assigned where numbering hierarchy is explicit (e.g., 1.1 -> 1.). Where parent was not clearly indicated, parentId left null and warning added.\",\n  \"nodes\": [\n    {\n      \"id\": \"n1\",\n      \"parentId\": null,\n      \"title\": \"Level 1\",\n      \"description\": null,\n      \"wbsLevel\": \"Level 1\",\n      \"metadata\": [],\n      \"provenance\": {\n        \"regionId\": \"59de81e2-0e6c-4346-b975-a32e937c806e\",\n        \"pageOrSheet\": \"unknown\",\n        \"sourceType\": \"paragraph_span\",\n        \"diRefs\": {\n          \"note\": \"fallback_region\"\n        },\n        \"bbox\": [\n          {\n            \"x\": 3.6925,\n            \"y\": 2.5183,\n            \"w\": 0.5494,\n            \"h\": 0.1416,\n            \"page\": 1\n          }\n        ],\n        \"quote\": \"Level 1\"\n      },\n      \"inferred\": false,\n      \"warnings\": [\n        \"ambiguous_parent\"\n      ]\n    },\n    {\n      \"id\": \"n2\",\n      \"parentId\": null,\n      \"title\": \"Deliverables = 100\",\n      \"description\": null,\n      \"wbsLevel\": null,\n      \"metadata\": [],\n      \"provenance\": {\n        \"regionId\": \"59de81e2-0e6c-4346-b975-a32e937c806e\",\n        \"pageOrSheet\": \"unknown\",\n        \"sourceType\": \"paragraph_span\",\n        \"diRefs\": {\n          \"note\": \"fallback_region\"\n        },\n        \"bbox\": [\n          {\n            \"x\": 3.2631,\n            \"y\": 2.7073,\n            \"w\": 1.424,\n            \"h\": 0.14909999999999986,\n            \"page\": 1\n          }\n        ],\n        \"quote\": \"Deliverables = 100\"\n      },\n      \"inferred\": false,\n      \"warnings\": [\n        \"ambiguous_parent\"\n      ]\n    },\n    {\n      \"id\": \"n3\",\n      \"parentId\": null,\n      \"title\": \"Construction of\",\n      \"description\": null,\n      \"wbsLevel\": null,\n      \"metadata\": [],\n      \"provenance\": {\n        \"regionId\": \"59de81e2-0e6c-4346-b975-a32e937c806e\",\n        \"pageOrSheet\": \"unknown\",\n        \"sourceType\": \"paragraph_span\",\n        \"diRefs\": {\n          \"note\": \"fallback_region\"\n        },\n        \"bbox\": [\n          {\n            \"x\": 5.4478,\n            \"y\": 2.7389,\n            \"w\": 1.4786000000000001,\n            \"h\": 0.17170000000000012,\n            \"page\": 1\n          }\n        ],\n        \"quote\": \"Construction of\"\n      },\n      \"inferred\": false,\n      \"warnings\": [\n        \"ambiguous_parent\"\n      ]\n    },\n    {\n      \"id\": \"n4\",\n      \"parentId\": null,\n      \"title\": \"a House\",\n      \"description\": null,\n      \"wbsLevel\": null,\n      \"metadata\": [],\n      \"provenance\": {\n        \"regionId\": \"59de81e2-0e6c-4346-b975-a32e937c806e\",\n        \"pageOrSheet\": \"unknown\",\n        \"sourceType\": \"paragraph_span\",\n        \"diRefs\": {\n          \"note\": \"fallback_region\"\n        },\n        \"bbox\": [\n          {\n            \"x\": 5.7895,\n            \"y\": 2.9887,\n            \"w\": 0.7913000000000002,\n            \"h\": 0.1585000000000004,\n            \"page\": 1\n          }\n        ],\n        \"quote\": \"a House\"\n      },\n      \"inferred\": false,\n      \"warnings\": [\n        \"ambiguous_parent\"\n      ]\n    },\n    {\n      \"id\": \"n5\",\n      \"parentId\": \"n1\",\n      \"title\": \"Level 2 = 100\",\n      \"description\": null,\n      \"wbsLevel\": \"Level 2 = 100\",\n      \"metadata\": [],\n      \"provenance\": {\n        \"regionId\": \"59de81e2-0e6c-4346-b975-a32e937c806e\",\n        \"pageOrSheet\": \"unknown\",\n        \"sourceType\": \"paragraph_span\",\n        \"diRefs\": {\n          \"note\": \"fallback_region\"\n        },\n        \"bbox\": [\n          {\n            \"x\": 1.3291,\n            \"y\": 3.8329,\n            \"w\": 0.9036999999999999,\n            \"h\": 0.13690000000000003,\n            \"page\": 1\n          }\n        ],\n        \"quote\": \"Level 2 = 100\"\n      },\n      \"inferred\": false,\n      \"warnings\": []\n    },\n    {\n      \"id\": \"n6\",\n      \"parentId\": \"n5\",\n      \"title\": \"1. Internal\",\n      \"description\": null,\n      \"wbsLevel\": null,\n      \"metadata\": [],\n      \"provenance\": {\n        \"regionId\": \"59de81e2-0e6c-4346-b975-a32e937c806e\",\n        \"pageOrSheet\": \"unknown\",\n        \"sourceType\": \"paragraph_span\",\n        \"diRefs\": {\n          \"note\": \"fallback_region\"\n        },\n        \"bbox\": [\n          {\n            \"x\": 2.7384,\n            \"y\": 3.9231,\n            \"w\": 0.8029,\n            \"h\": 0.13830000000000044,\n            \"page\": 1\n          }\n        ],\n        \"quote\": \"1. Internal\"\n      },\n      \"inferred\": false,\n      \"warnings\": []\n    },\n    {\n      \"id\": \"n7\",\n      \"parentId\": \"n5\",\n      \"title\": \"2. Foundation\",\n      \"description\": null,\n      \"wbsLevel\": null,\n      \"metadata\": [],\n      \"provenance\": {\n        \"regionId\": \"59de81e2-0e6c-4346-b975-a32e937c806e\",\n        \"pageOrSheet\": \"unknown\",\n        \"sourceType\": \"paragraph_span\",\n        \"diRefs\": {\n          \"note\": \"fallback_region\"\n        },\n        \"bbox\": [\n          {\n            \"x\": 5.6969,\n            \"y\": 3.9205,\n            \"w\": 1.0736,\n            \"h\": 0.14230000000000015,\n            \"page\": 1\n          }\n        ],\n        \"quote\": \"2. Foundation\"\n      },\n      \"inferred\": false,\n      \"warnings\": []\n    },\n    {\n      \"id\": \"n8\",\n      \"parentId\": \"n5\",\n      \"title\": \"3. External\",\n      \"description\": null,\n      \"wbsLevel\": null,\n      \"metadata\": [],\n      \"provenance\": {\n        \"regionId\": \"59de81e2-0e6c-4346-b975-a32e937c806e\",\n        \"pageOrSheet\": \"unknown\",\n        \"sourceType\": \"paragraph_span\",\n        \"diRefs\": {\n          \"note\": \"fallback_region\"\n        },\n        \"bbox\": [\n          {\n            \"x\": 8.7726,\n            \"y\": 3.9198,\n            \"w\": 0.8489000000000006,\n            \"h\": 0.1433000000000002,\n            \"page\": 1\n          }\n        ],\n        \"quote\": \"3. External\"\n      },\n      \"inferred\": false,\n      \"warnings\": []\n    },\n    {\n      \"id\": \"n9\",\n      \"parentId\": null,\n      \"title\": \"Level 3\",\n      \"description\": null,\n      \"wbsLevel\": \"Level 3\",\n      \"metadata\": [],\n      \"provenance\": {\n        \"regionId\": \"59de81e2-0e6c-4346-b975-a32e937c806e\",\n        \"pageOrSheet\": \"unknown\",\n        \"sourceType\": \"paragraph_span\",\n        \"diRefs\": {\n          \"note\": \"fallback_region\"\n        },\n        \"bbox\": [\n          {\n            \"x\": 0.7643,\n            \"y\": 4.6435,\n            \"w\": 0.4048000000000001,\n            \"h\": 0.11520000000000009,\n            \"page\": 1\n          }\n        ],\n        \"quote\": \"Level 3\"\n      },\n      \"inferred\": false,\n      \"warnings\": [\n        \"ambiguous_parent\"\n      ]\n    },\n    {\n      \"id\": \"n10\",\n      \"parentId\": null,\n      \"title\": \"Work Packages = 100\",\n      \"description\": null,\n      \"wbsLevel\": null,\n      \"metadata\": [],\n      \"provenance\": {\n        \"regionId\": \"59de81e2-0e6c-4346-b975-a32e937c806e\",\n        \"pageOrSheet\": \"unknown\",\n        \"sourceType\": \"paragraph_span\",\n        \"diRefs\": {\n          \"note\": \"fallback_region\"\n        },\n        \"bbox\": [\n          {\n            \"x\": 0.3613,\n            \"y\": 4.7822,\n            \"w\": 1.2086999999999998,\n            \"h\": 0.13549999999999988,\n            \"page\": 1\n          }\n        ],\n        \"quote\": \"Work Packages = 100\"\n      },\n      \"inferred\": false,\n      \"warnings\": [\n        \"ambiguous_parent\"\n      ]\n    },\n    {\n      \"id\": \"n11\",\n      \"parentId\": \"n6\",\n      \"title\": \"1.1 Electricity\",\n      \"description\": null,\n      \"wbsLevel\": null,\n      \"metadata\": [],\n      \"provenance\": {\n        \"regionId\": \"59de81e2-0e6c-4346-b975-a32e937c806e\",\n        \"pageOrSheet\": \"unknown\",\n        \"sourceType\": \"paragraph_span\",\n        \"diRefs\": {\n          \"note\": \"fallback_region\"\n        },\n        \"bbox\": [\n          {\n            \"x\": 2.0784,\n            \"y\": 4.7591,\n            \"w\": 0.9431000000000002,\n            \"h\": 0.14300000000000013,\n            \"page\": 1\n          }\n        ],\n        \"quote\": \"1.1 Electricity\"\n      },\n      \"inferred\": false,\n      \"warnings\": []\n    },\n    {\n      \"id\": \"n12\",\n      \"parentId\": \"n6\",\n      \"title\": \"1.2 Plumbing\",\n      \"description\": null,\n      \"wbsLevel\": null,\n      \"metadata\": [],\n      \"provenance\": {\n        \"regionId\": \"59de81e2-0e6c-4346-b975-a32e937c806e\",\n        \"pageOrSheet\": \"unknown\",\n        \"sourceType\": \"paragraph_span\",\n        \"diRefs\": {\n          \"note\": \"fallback_region\"\n        },\n        \"bbox\": [\n          {\n            \"x\": 3.2923,\n            \"y\": 4.7602,\n            \"w\": 0.9266,\n            \"h\": 0.1439000000000002,\n            \"page\": 1\n          }\n        ],\n        \"quote\": \"1.2 Plumbing\"\n      },\n      \"inferred\": false,\n      \"warnings\": []\n    },\n    {\n      \"id\": \"n13\",\n      \"parentId\": \"n7\",\n      \"title\": \"2.1 Excavation\",\n      \"description\": null,\n      \"wbsLevel\": null,\n      \"metadata\": [],\n      \"provenance\": {\n        \"regionId\": \"59de81e2-0e6c-4346-b975-a32e937c806e\",\n        \"pageOrSheet\": \"unknown\",\n        \"sourceType\": \"paragraph_span\",\n        \"diRefs\": {\n          \"note\": \"fallback_region\"\n        },\n        \"bbox\": [\n          {\n            \"x\": 5.0471,\n            \"y\": 4.7603,\n            \"w\": 1.0332999999999998,\n            \"h\": 0.1325,\n            \"page\": 1\n          }\n        ],\n        \"quote\": \"2.1 Excavation\"\n      },\n      \"inferred\": false,\n      \"warnings\": []\n    },\n    {\n      \"id\": \"n14\",\n      \"parentId\": \"n7\",\n      \"title\": \"2.2 Steel Erection\",\n      \"description\": null,\n      \"wbsLevel\": null,\n      \"metadata\": [],\n      \"provenance\": {\n        \"regionId\": \"59de81e2-0e6c-4346-b975-a32e937c806e\",\n        \"pageOrSheet\": \"unknown\",\n        \"sourceType\": \"paragraph_span\",\n        \"diRefs\": {\n          \"note\": \"fallback_region\"\n        },\n        \"bbox\": [\n          {\n            \"x\": 6.329,\n            \"y\": 4.7595,\n            \"w\": 1.2401999999999996,\n            \"h\": 0.13420000000000035,\n            \"page\": 1\n          }\n        ],\n        \"quote\": \"2.2 Steel Erection\"\n      },\n      \"inferred\": false,\n      \"warnings\": []\n    },\n    {\n      \"id\": \"n15\",\n      \"parentId\": \"n8\",\n      \"title\": \"3.1 Masonry Work\",\n      \"description\": null,\n      \"wbsLevel\": null,\n      \"metadata\": [],\n      \"provenance\": {\n        \"regionId\": \"59de81e2-0e6c-4346-b975-a32e937c806e\",\n        \"pageOrSheet\": \"unknown\",\n        \"sourceType\": \"paragraph_span\",\n        \"diRefs\": {\n          \"note\": \"fallback_region\"\n        },\n        \"bbox\": [\n          {\n            \"x\": 7.8047,\n            \"y\": 4.7592,\n            \"w\": 1.2532999999999998,\n            \"h\": 0.14119999999999998,\n            \"page\": 1\n          }\n        ],\n        \"quote\": \"3.1 Masonry Work\"\n      },\n      \"inferred\": false,\n      \"warnings\": []\n    },\n    {\n      \"id\": \"n16\",\n      \"parentId\": \"n8\",\n      \"title\": \"3.2 Building Finishes\",\n      \"description\": null,\n      \"wbsLevel\": null,\n      \"metadata\": [],\n      \"provenance\": {\n        \"regionId\": \"59de81e2-0e6c-4346-b975-a32e937c806e\",\n        \"pageOrSheet\": \"unknown\",\n        \"sourceType\": \"paragraph_span\",\n        \"diRefs\": {\n          \"note\": \"fallback_region\"\n        },\n        \"bbox\": [\n          {\n            \"x\": 9.309,\n            \"y\": 4.7568,\n            \"w\": 1.4350000000000005,\n            \"h\": 0.1460999999999999,\n            \"page\": 1\n          }\n        ],\n        \"quote\": \"3.2 Building Finishes\"\n      },\n      \"inferred\": false,\n      \"warnings\": []\n    },\n    {\n      \"id\": \"n17\",\n      \"parentId\": \"n11\",\n      \"title\": \"1.1.1 Rough-in electrical\",\n      \"description\": null,\n      \"wbsLevel\": null,\n      \"metadata\": [],\n      \"provenance\": {\n        \"regionId\": \"59de81e2-0e6c-4346-b975-a32e937c806e\",\n        \"pageOrSheet\": \"unknown\",\n        \"sourceType\": \"paragraph_span\",\n        \"diRefs\": {\n          \"note\": \"fallback_region\"\n        },\n        \"bbox\": [\n          {\n            \"x\": 0.3319,\n            \"y\": 5.5791,\n            \"w\": 1.2272000000000001,\n            \"h\": 0.12060000000000012,\n            \"page\": 1\n          }\n        ],\n        \"quote\": \"1.1.1 Rough-in electrical\"\n      },\n      \"inferred\": false,\n      \"warnings\": []\n    },\n    {\n      \"id\": \"n18\",\n      \"parentId\": \"n11\",\n      \"title\": \"1.1.2 Install and terminate\",\n      \"description\": null,\n      \"wbsLevel\": null,\n      \"metadata\": [],\n      \"provenance\": {\n        \"regionId\": \"59de81e2-0e6c-4346-b975-a32e937c806e\",\n        \"pageOrSheet\": \"unknown\",\n        \"sourceType\": \"paragraph_span\",\n        \"diRefs\": {\n          \"note\": \"fallback_region\"\n        },\n        \"bbox\": [\n          {\n            \"x\": 1.8714,\n            \"y\": 5.5809,\n            \"w\": 1.3501,\n            \"h\": 0.10990000000000001,\n            \"page\": 1\n          }\n        ],\n        \"quote\": \"1.1.2 Install and terminate\"\n      },\n      \"inferred\": false,\n      \"warnings\": []\n    },\n    {\n      \"id\": \"n19\",\n      \"parentId\": \"n11\",\n      \"title\": \"1.1.3 HVAC equipment\",\n      \"description\": null,\n      \"wbsLevel\": null,\n      \"metadata\": [],\n      \"provenance\": {\n        \"regionId\": \"59de81e2-0e6c-4346-b975-a32e937c806e\",\n        \"pageOrSheet\": \"unknown\",\n        \"sourceType\": \"paragraph_span\",\n        \"diRefs\": {\n          \"note\": \"fallback_region\"\n        },\n        \"bbox\": [\n          {\n            \"x\": 3.5232,\n            \"y\": 5.5777,\n            \"w\": 1.1892000000000003,\n            \"h\": 0.12290000000000023,\n            \"page\": 1\n          }\n        ],\n        \"quote\": \"1.1.3 HVAC equipment\"\n      },\n      \"inferred\": false,\n      \"warnings\": []\n    },\n    {\n      \"id\": \"n20\",\n      \"parentId\": \"n14\",\n      \"title\": \"2.2.1 Columns\",\n      \"description\": null,\n      \"wbsLevel\": null,\n      \"metadata\": [],\n      \"provenance\": {\n        \"regionId\": \"59de81e2-0e6c-4346-b975-a32e937c806e\",\n        \"pageOrSheet\": \"unknown\",\n        \"sourceType\": \"paragraph_span\",\n        \"diRefs\": {\n          \"note\": \"fallback_region\"\n        },\n        \"bbox\": [\n          {\n            \"x\": 5.5895,\n            \"y\": 5.5837,\n            \"w\": 0.7617000000000006,\n            \"h\": 0.10440000000000031,\n            \"page\": 1\n          }\n        ],\n        \"quote\": \"2.2.1 Columns\"\n      },\n      \"inferred\": false,\n      \"warnings\": []\n    }\n  ],\n  \"unmappedEvidence\": [\n    {\n      \"evidenceId\": \"fallback_region\",\n      \"text\": \"Work\",\n      \"reason\": \"not_extracted_as_node\"\n    },\n    {\n      \"evidenceId\": \"fallback_region\",\n      \"text\": \"100,00%\",\n      \"reason\": \"not_extracted_as_node\"\n    },\n    {\n      \"evidenceId\": \"fallback_region\",\n      \"text\": \"Budget $215.500,00\",\n      \"reason\": \"not_extracted_as_node\"\n    },\n    {\n      \"evidenceId\": \"fallback_region\",\n      \"text\": \"45,60%\",\n      \"reason\": \"not_extracted_as_node\"\n    },\n    {\n      \"evidenceId\": \"fallback_region\",\n      \"text\": \"24,00%\",\n      \"reason\": \"not_extracted_as_node\"\n    },\n    {\n      \"evidenceId\": \"fallback_region\",\n      \"text\": \"30,40%\",\n      \"reason\": \"not_extracted_as_node\"\n    },\n    {\n      \"evidenceId\": \"fallback_region\",\n      \"text\": \"Budget $83.500,00\",\n      \"reason\": \"not_extracted_as_node\"\n    },\n    {\n      \"evidenceId\": \"fallback_region\",\n      \"text\": \"Budget $86.000,00\",\n      \"reason\": \"not_extracted_as_node\"\n    },\n    {\n      \"evidenceId\": \"fallback_region\",\n      \"text\": \"Budget $46.000,00\",\n      \"reason\": \"not_extracted_as_node\"\n    },\n    {\n      \"evidenceId\": \"fallback_region\",\n      \"text\": \"Budget $25.000,00\",\n      \"reason\": \"not_extracted_as_node\"\n    },\n    {\n      \"evidenceId\": \"fallback_region\",\n      \"text\": \"Budget $61.000,00\",\n      \"reason\": \"not_extracted_as_node\"\n    },\n    {\n      \"evidenceId\": \"fallback_region\",\n      \"text\": \"Budget $37.000,00\",\n      \"reason\": \"not_extracted_as_node\"\n    },\n    {\n      \"evidenceId\": \"fallback_region\",\n      \"text\": \"Budget $9.000,00\",\n      \"reason\": \"not_extracted_as_node\"\n    },\n    {\n      \"evidenceId\": \"fallback_region\",\n      \"text\": \"Budget $62.000,00\",\n      \"reason\": \"not_extracted_as_node\"\n    },\n    {\n      \"evidenceId\": \"fallback_region\",\n      \"text\": \"Budget $21.500,00\",\n      \"reason\": \"not_extracted_as_node\"\n    }\n  ]\n}"
        }
      ],
      "role": "assistant"
    }
  ],
  "parallel_tool_calls": true,
  "previous_response_id": null,
  "prompt_cache_key": null,
  "prompt_cache_retention": null,
  "reasoning": {
    "effort": "medium",
    "summary": null
  },
  "safety_identifier": null,
  "service_tier": "default",
  "store": true,
  "temperature": 1,
  "text": {
    "format": {
      "type": "text"
    },
    "verbosity": "medium"
  },
  "tool_choice": "auto",
  "tools": [],
  "top_logprobs": 0,
  "top_p": 1,
  "truncation": "disabled",
  "usage": {
    "input_tokens": 4204,
    "input_tokens_details": {
      "cached_tokens": 0
    },
    "output_tokens": 12646,
    "output_tokens_details": {
      "reasoning_tokens": 7744
    },
    "total_tokens": 16850
  },
  "user": null,
  "metadata": {}
}
*/